name: üîÑ Auto Clear Cloudflare Cache

on:
  push:   
    branches:
      - main   # Â¶ÇÊûú‰Ω†Áî® gh-pagesÔºåÊää main Êîπ‰∏∫ gh-pages
  workflow_dispatch:   # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  purge_cloudflare:
    name: Purge Cloudflare Cache
    runs-on: ubuntu-latest

    steps:
      - name: Show info
        run: |
          echo "Run by: $GITHUB_ACTOR"
          echo "Repo: $GITHUB_REPOSITORY"
      
      - name: Purge Cloudflare cache (purge everything)
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID:   ${{ secrets.CF_ZONE_ID }}
        run: |
          if [ -z "$CF_API_TOKEN" ] || [ -z "$CF_ZONE_ID" ]; then
            echo "ERROR: CF_API_TOKEN or CF_ZONE_ID not set as repository secrets"
            exit 1
          fi

          echo "Calling Cloudflare API to purge cache for zone: $CF_ZONE_ID"
          resp=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')

          echo "Response: $resp"
          ok=$(echo "$resp" | grep -o '"success":true' || true)
          if [ -z "$ok" ]; then
            echo "Cloudflare purge appears to have failed."
            exit 1
          fi

          echo "‚úÖ Cloudflare cache purged successfully."
